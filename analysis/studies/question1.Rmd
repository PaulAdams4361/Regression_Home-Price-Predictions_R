---
title: "Question 1"
author: "Stuart Miller"
date: "July 28, 2019"
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Requested Analysis

Century 21 Ames wants to understand if there is a relationship between the square footage of the living areas of houses (`GrLivArea`) and sale price in the neighborhood where they operate Northwest Ames, Edwards, and Brookside (`NAmes`, `Edwards` and `BrkSide`).

```{r, lib-read, results='hide', message=FALSE, include=FALSE}
### Compuational Setup
# libraries
library(knitr)
library(tidyverse)
library(olsrr)
library(gridExtra)
library(caret)

# set a random seed for repodicibility
set.seed(123)

# helper code
source('../helper/visual.R')
source('../helper/data_munging.R')
source('../helper/performance.R')

# load data
train <- read_csv('../data/train.csv')
test <- read_csv('../data/test.csv')
```

# Analysis

## Extract Data of Interest

```{r data-filtering, results='hide', message=FALSE}
# select data of interest
train <- train %>% 
  filter(Neighborhood %in% c("Edwards", "BrkSide", "NAmes"))
train$Neighborhood <- as.factor(train$Neighborhood)
```

## Plots of Data

Barplot of count houses in `Neighborhood`s of interest.

```{r, message=FALSE}
train %>% ggplot(aes(x = Neighborhood)) + geom_bar() + 
  labs(title = 'Count of Levels of Neighborhood', 
       y = 'Count')
```

Histogram of `SalePrice`, which is the sale price of the houses in the dataset.

```{r, SalePriceHist, message=FALSE}
train %>% ggplot(aes(x = SalePrice)) +
  geom_histogram() + 
  labs(title = 'Histogram of Sale Price', 
       y = 'Frequency', x = 'Sale Price')
```

Histogram of `GrLivArea`, which is the square footage of the living areas of houses in the dataset.

```{r, LivingRoomHist, message=FALSE}
train %>% ggplot(aes(x = GrLivArea)) +
  geom_histogram() + 
  labs(title = 'Histogram of Living Room Area', 
       y = 'Frequency', x = 'Living Room Area')
```

Both variables (`SalePrice` and `GrLivArea`) show evidence of right skew. This could indicate need for a log transform.

Scatter plot of `SalePrice` vs `GrLivArea` shows that the large values in `GrLivArea` are pulling the regression line. A log transfrom on `GrLivArea` may help correct this.

```{r, regression-original-scale}
train %>% ggplot(aes(x = GrLivArea, y = SalePrice)) +
  geom_point(alpha = 0.3) +
  labs(title = 'Sale Price vs Living Room Area', 
       y = 'Log of Sale Price', x = 'Living Room Area')
```

Scatter plot of `SalePrice` vs log transform of `GrLivArea` shows taking the log transform of `GrLivArea` does improve the linear relationship. However, it appears that a larger value of `GrLivArea` is associated with an increase in varaince of `SalePrice`. A log transform of `SalePrice` may help control for this change in varaince.

```{r, linear-log-plot}
train %>% ggplot(aes(x = log(GrLivArea), y = SalePrice)) +
  geom_point(alpha = 0.3) +
  labs(title = 'Sale Price vs Log of Living Room Area', 
       y = 'Sale Price', x = 'Log of Living Room Area')
```

Scatter plot the log transform of `SalePrice` vs the log transform of `GrLivArea` shows evidece of a linear relationship without sufficient evidence of changing variance. Two points to the right side of the plot appear to be pulling the regression line to the right. These points should be investigated.

```{r, log-log-plot}
train %>% ggplot(aes(x = log(GrLivArea), y = log(SalePrice))) +
  geom_point(alpha = 0.3) + 
  labs(title = 'Log of Sale Price vs Log of Living Room Area', 
       y = 'Log of Sale Price', x = 'Log of Living Room Area')
```

Add labels of `SaleCondition` of the two points of interest and some neighboring points to the scatter plot the log transform of `SalePrice` vs the log transform of `GrLivArea`. This indicates the influential points are of type `Partial` `SaleCondition`, which means the houses were not completed at the time of assessment.

```{r, log-log-plot-labeled}
train %>% ggplot(aes(x = log(GrLivArea), y = log(SalePrice))) +
  geom_point(alpha = 0.3) +
  labs(title = 'Log of Sale Price vs Log of Living Room Area', 
       y = 'Log of Sale Price', x = 'Log of Living Room Area') +
  geom_text(aes(label = ifelse((log(GrLivArea) > 7.75 & log(SalePrice) > 11) |
                                 (log(SalePrice) > 12.45),
                               SaleCondition, '')), hjust=0, vjust=0)
```


Scatter plot log of sale price vs log of living room area for each neighborhood. In each case, there is not sigificant evidence against the assumption of linearity.

```{r, log-log-plot-by-N}
regplot.names <- train %>% filter(Neighborhood == 'NAmes') %>%
  ggplot(aes(x = log(GrLivArea), y = log(SalePrice))) +
  geom_point(alpha = 0.3) +
  ylim(10.5, 13) +
  xlim(5.5, 9) +
  geom_smooth(method = 'lm') +
  labs(subtitle = 'Northwest Ames', 
       y = 'Log of Sale Price', x = 'Log of Living Room Area')

regplot.ed <- train %>% filter(Neighborhood == 'Edwards') %>%
  ggplot(aes(x = log(GrLivArea), y = log(SalePrice))) +
  geom_point(alpha = 0.3) +
  ylim(10.5, 13) +
  xlim(5.5, 9) +
  geom_smooth(method = 'lm') +
  labs(subtitle = 'Edwards', 
       y = 'Log of Sale Price', x = 'Log of Living Room Area')

regplot.brk <- train %>% filter(Neighborhood == 'BrkSide') %>%
  ggplot(aes(x = log(GrLivArea), y = log(SalePrice))) +
  geom_point(alpha = 0.3) +
  ylim(10.5, 13) +
  xlim(5.5, 9) +
  geom_smooth(method = 'lm') +
  labs(subtitle = 'Brook Side', 
       y = 'Log of Sale Price', x = 'Log of Living Room Area')
grid.arrange(regplot.names,regplot.ed,regplot.brk, nrow = 2,
             top = 'Regression Plots for Neighborhoods')
```



```{r}
train %>% ggplot(aes(x = log(GrLivArea), y = log(SalePrice), color = Neighborhood)) +
  geom_point(alpha = 0.3) + 
  labs(subtitle = 'Brook Side', 
       y = 'Log of Sale Price', x = 'Log of Living Room Area')
```

## Model

Based on the log-log plot above, the response will be modeled as

![model_equation](./question1_files/model_equation.png)

where Edwards neighborhood is used for reference.

### Interaction Terms

We will use an extra sums of square test to verify that the interaction terms are useful for the model. The ESS test provides strong evidence that the interaction terms are useful (p-value = 0.0002); thus, we will continue with the full model.

```{r, ESS}
# create dummy variables with Neighborhood == 'Edwards' as reference
train <- get.dummies(train, "Neighborhood", reference = 'Edwards')

# full model formula
model.formula = log(SalePrice) ~ log(GrLivArea) + 
     Neighborhood_BrkSide + 
     Neighborhood_NAmes +
     log(GrLivArea) * Neighborhood_BrkSide + 
     log(GrLivArea) * Neighborhood_NAmes
# reduced model formula
model.reduced.formula = log(SalePrice) ~ log(GrLivArea) + 
     Neighborhood_BrkSide + 
     Neighborhood_NAmes

# fit models
model <- lm(formula = model.formula, data = train)
model.reduced <- lm(formula = model.reduced.formula, data = train)
# ESS test on models
anova(model.reduced, model)

```


### Parameter Estimation

Estimate parameters in the model by fitting to the entire dataset to the chosen model.

```{r, modeling, message=FALSE}
# formula for model
model.formula = log(SalePrice) ~ log(GrLivArea) + 
     Neighborhood_BrkSide + 
     Neighborhood_NAmes +
     log(GrLivArea) * Neighborhood_BrkSide + 
     log(GrLivArea) * Neighborhood_NAmes

# model the mean response given equation above
model <- lm(formula = model.formula, data = train)
summary(model)
confint(model)
```

### Model Accuracy Estimation

Use 10-fold cross validation to estimate the accuracy metrics of the model.

```{r, cross-validation}
# Set up repeated k-fold cross-validation
train.control <- trainControl(method = "cv", number = 10)
# Train the model
model.cv <- train(model.formula, 
                    data = train,
                    method = 'lm',
                    trControl = train.control)
# print model summary
model.cv

# get the CV results
res <- model.cv$results

# get cross-validated PRESS statistic
PCV <- PRESS.cv(model.cv)

# print accuracy metrics to md table
kable(data.frame('RMSE'=res$RMSE,
           'CV Press'=PCV,
           'Adjused R Squared'=res$Rsquared))
```


## Model Assumptions Assessment

* **Linearity**: It appear reasonable that the log of sale price and the log of living room area could be linearly related based on a scatter plot.
* **Normality**: The residuals from the model fit appear to be normally distributed based on a histogram and qq plot.
* **Constant Variance**: There is no discernable pattern from a scatter plot of residuals and studentized residuals plotted vs predicted value.
* **Independence**: It is not clear how the data was sampled. We will assume this is true and continue.

```{r, diag-plots}
basic.fit.plots(train, model)
ols_plot_resid_lev(model)
ols_plot_cooksd_bar(model)
```


## Conclusion

TODO

* Provide model
* Interpretation
  * Statistally significant relationship between edwards neighborhood and sale price
  * No statistical difference between Edwards and Northwest Ames
  * Statistical difference between Edwards and Brook Side
* Scope
  * Unknown sampling method -> no extension
  * Observational
  













